<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>添加会员</title>
    <script src="js/flexible.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-1.10.1.min.js"></script>
</head>
<body>
	<section>
		<section class="form">
			<form>
				<div class="left">
					<div class="preview">
						<img id="img" class="ab_center" src="" alt="">
						<span id="rephoto" class="rephoto"></span>
						<span id="prompt" class="prompt t-c">请添加本人脸部照片</span>
					</div>
					<input id="imageFile" class="hide" type="file" name="image" accept="image/*">
				</div>
				<div class="right">
					<div><input id="username" class="username formInput" type="text" name="username" placeholder="请输入您的姓名"><span class="icon">*</span></div>
					<div><input id="phone" class="phone formInput" type="text" name="phone" placeholder="请输入您的手机号"><span class="icon">*</span></div>
				</div>
				<button id="submit" class="submit">提 交</button>
			</form>
		</section>
	</section>


<!-- 遮罩和弹框 -->
	<div class="mask hide"></div>
	<div id="alert_dialog" class="ab_center dialog hide">
		<div class="top t-c alert_info"><span class="alert_icon"></span><p id="alert_dialog_info" class="alert_dialog_info">请先添加本人脸部照片</p></div>
		<hr class="ab_center">
		<button class="bottom t-c dia_botton takePhoto">确定</button>
	</div>
	<div id="info_dialog" class="ab_center dialog hide">
		<div class="top t-c alert_info"><span class="alert_icon"></span><p id="info_dialog_info" class="alert_dialog_info">请填入正确信息</p></div>
		<hr class="ab_center">
		<button class="bottom t-c dia_botton cancel">确定</button>
	</div>
	<div id="loading" class="loader hide">
		<ul class="loading">
	      <li></li>
	      <li></li>
	      <li></li>
	      <li></li>
	      <li></li>
	    </ul>
	    <span class="waiting">请稍后...</span>
	</div>

	<div id="successPaper" class="successPaper ab_center hide">
		<div class="gift-icon"></div>
		<div class="success-info">
			<p><span class="hook-icon"></span>提交成功</p>
			<p>请找工作人员领取 <strong>神秘大奖！</strong></p>
		</div>
	</div>
<script>
	(function(global,$,doc){

	})(this,this.jQuery,document);
    $(function(){
    	// 事件初始化
        _eventInit();
        // 确认通过正确方式登录
        _checkLogin();
        // 检测有无faceUrl
        _checkFaceUrl();
        _showRePhoto();
    });
	var isRepeat = false,
		retaken = false,	// 是否重拍
		useFaceUrl = true,	// 是否使用faceUrl地址作为图片
    	disable = false,	// 阻止重复提交开关

    	// 检测输入类
    	checkInput = {
						checkName : {
							errorInfo : "",
							index : 0,
							checkFunc : function(input,callback){
								var input = checkInput._trim(input),
									empty = false;
								input = checkInput._htmlFilter(input);
								empty = checkInput._checkEmpty(input);
								if(empty){
									this.errorInfo = "请输入姓名";
									return;
								}else{
									this.errorInfo = "";
							    	callback(input);
								}
							}
						},
						checkPhone : {
							errorInfo : "",
							index : 1,
							checkFunc : function(input,callback){
								var input = checkInput._trim(input);
								input = checkInput._htmlFilter(input);
							    if(!(/^1\d{10}$/.test(input))){
							    	this.errorInfo = "请输入正确的手机号";
							    	return;
							    }else{
							    	this.errorInfo = "";
							    	callback(input);
							    }
							},
						},

						// 判空
						_checkEmpty : function(input){
							var input = checkInput._trim(input);
							if(input.length > 0) return false;
							return true;
						},
						// 去空
						_trim : function(input){
							var input = input.toString();
							if(input.trim)input = input.trim();
							input = input.replace(/\s/g,"");
							return input;
						},
						// 过滤非法字符
						_htmlFilter : function(input){
							var input = input;
							input = input.replace(/[\[\]<>\?]/g,"");
							return input;
						},
						// 判断能否提交
						_canSendOrNot : function(callback){
							for(i in this){
								if(i.toString()[0] === "_")continue;
								if(this[i].errorInfo.length > 0){
									if(callback)callback(this[i].index,this[i].errorInfo);
									return false;
								}
							}
							return true;
						}
					},
		sendFile = null,		// 上传的图片文件
		amusementInfo = {		// 活动信息
			amusementId : getUrlParam("amusementId"),
			depId : getUrlParam("depId"),
			faceUrl : getUrlParam("faceUrl")
		},
		userInfo = {			// 用户信息
			name : "",
			phoneNumber : ""
		},
		firstUpload = true;		// 第一次上传的标识


	function _eventInit(){

	    // 拍照
        $(".takePhoto").click(function(){
            $("#imageFile").click();
            hideDialog([".dialog",".mask"]);
        });

		// 取消
		$(".cancel").click(function(){
			if(!retaken){
				hideDialog([".dialog",".mask"]);
			}else{
				retaken = false;
				$("#imageFile").click();
				hideDialog([".dialog",".mask"]);
			}
		});


		// fileInput的change事件
		$("#imageFile").change(function(){
		    var self = this;
		    useFaceUrl = false;
            if(this.files[0]){
            	showDialog("#loading");		// 开loading
            	imgResize(this.files[0],function(blob){
	            	sendFile = blob;		// 给file
	            	firstUpload = false;	// 改变flag值
	            	hideDialog(["#loading",".mask"]);
	            	_showRePhoto();			// 显示重新拍照icon
	            })
            }else{
            	$("#img").attr('src','');
            	firstUpload = true;
            	$("#rephoto").hide();
				hideDialog(["mask"]);
            }
		});

		// 点击提交
		$("#submit").click(function(e){
		    e.preventDefault();
		    submit(function(res){
		    	// 开启开关
				disable = true;
				if(res.result === "ok"){
					$("#successPaper").removeClass('hide');
                    isRepeat = true;
                    $("input").attr("disabled",true);
                    hideDialog(["#loading",".mask"]);
					return;
				}else if(res.result === "FACE_RECOGNIZE_FAILED"){
					hideDialog(["#loading"]);
					$("#info_dialog_info").text("认证失败，请重拍");
					retaken = true;
					// 提交按钮重置
					$("#submit").removeClass("disable");
					disable = false;
					showDialog("#info_dialog");
				}else if(res.result === "PHONE_NUMBER_ALREADY_EXIST"){
					hideDialog(["#loading"]);
					$("#info_dialog_info").text("手机号已被注册");

					// 提交按钮重置
					$("#submit").removeClass("disable");
					disable = false;
					showDialog("#info_dialog");
				} else{
					hideDialog(["#loading"]);
					showDialog("#info_dialog");
					$("#submit").removeClass("disable");
					disable = false;
					$("#info_dialog_info").text("系统正忙,请稍后重试");
					return;
				}
		    });
		});

		$(".preview").click(function(e){
		    if(isRepeat) return;
			if(firstUpload){	// 初次上传
                $("#imageFile").click();
			}else{
				return;
			}
		});

		$("#rephoto").click(function(e){
            if(isRepeat) return;
            $("#imageFile").click();
		});
	}

	// 检测登录
	function _checkLogin(){
		for(var i in amusementInfo){
			if(!amusementInfo[i] && i !== "faceUrl"){
				alert("请获取正确的报名链接");
				$("body").text("");
				window.close();
				return;
			}
		}
	}

	// 检测faceUrl
	function _checkFaceUrl(){
		var url = amusementInfo.faceUrl;
		if(url){
			$("#img").attr('src',url);
			$("#rephoto").show();
			firstUpload = false;
			useFaceUrl = true;
		}else{
			useFaceUrl = false;
		}
	}



	// 显示重新拍照icon的开关
	function _showRePhoto(){
		if(firstUpload){
			$("#rephoto").hide();
		}else{
			$("#rephoto").show();
		}
	}



	// 提交
	function submit(successCallBack){
		if(disable)return;	// 阻止重复提交
		var flag,
			formData;
		// 人脸检测****************************************************
		if(!$("#imageFile")[0].files[0] && !useFaceUrl){
			changeDialogInfo("请先添加本人脸部照片");
			showDialog("#alert_dialog");
			return;
		}

		// 数据检测*******************************************************
		flag = checkData();
		if(!flag){	// 检测不通过情况
			checkInput._canSendOrNot(function(index,errorInfo){
				$("#info_dialog_info").text(errorInfo);
				showDialog("#info_dialog");
			});
			return;
		}

		// 提交按钮置灰
		$("#submit").addClass("disable");

		// 开遮罩层
		showDialog("#loading");

		// 注册***********************************************************
		formData = fillFormData();
		$.ajax({
			url : "../../service/registMember.action",
			type : "POST",
			contentType : false,
			processData : false,
			cache : false,
			data : formData,
			success : function(res){
				successCallBack(res);
			},
			error : function(err){
				throw new Error(err);
				// 开启开关
				disable = true;
			}
		});
	}

	// 填充数据
	function fillFormData(){
		var formData = new FormData(),vipBoJson;
		if(useFaceUrl){
			vipBoJson = JSON.stringify({
				name : userInfo.name,
				phoneNumber : userInfo.phoneNumber,
				faceUrl : amusementInfo.faceUrl
			});
		}else{
			vipBoJson = JSON.stringify({
				name : userInfo.name,
				phoneNumber : userInfo.phoneNumber
			});
			formData.append("file",sendFile);
		}
		formData.append("vipBoJson",vipBoJson);
		formData.append("amusementId",amusementInfo.amusementId);
		formData.append("depId",amusementInfo.depId);
		return formData;
	}

	// 检测输入
	function checkData(){
		var username       = $("#username").val(),
			phoneNumber    = $("#phone").val();
		checkInput.checkName.checkFunc(username,function(input){
			userInfo.name = input;
		});
		checkInput.checkPhone.checkFunc(phoneNumber,function(input){
			userInfo.phoneNumber = input;
		});
		
		return checkInput._canSendOrNot();
	}


	// 改变弹出框提示语
	function changeDialogInfo(info){
		$("#alert_dialog_info").text(info);
	}


    /**
	 * 隐藏弹框
     * @param arr {array} 选择符数组
     */
	function hideDialog(arr){
		var target = arr.join(",");
		$(target).animate({
			opacity : 0
		},100,function(){
			$(target).hide();
		});
	}

	// 显示弹框
	function showDialog(dialogName){
		var target = dialogName + ",.mask";
		$(target).show().css({
			opacity : 0
		}).animate({
			opacity : 1
		},100);
	}



	// 图片压缩**************************************************************************************************************
	function imgResize(file, callback){
	  var fileReader = new FileReader();
	  fileReader.onload = function(){
	    var IMG = new Image();
	    IMG.src = this.result;
	    IMG.onload = function(){
	      var w = this.naturalWidth, h = this.naturalHeight, resizeW = 0, resizeH = 0;
	      // maxSize 是压缩的设置，设置图片的最大宽度和最大高度，等比缩放，level是报错的质量，数值越小质量越低
	      var maxSize = {
	        width: 500,
	        height: 500,
	        level: 0.6
	      };
	      if(w > maxSize.width || h > maxSize.height){
	        var multiple = Math.max(w / maxSize.width, h / maxSize.height);
	        resizeW = w / multiple;
	        resizeH = h / multiple;
	      } else {
	        // 如果图片尺寸小于最大限制，则不压缩直接上传
	        $("#img").attr("src",IMG.src);
	        return callback(file)
	      }
	      var canvas = document.createElement('canvas'),
	      ctx = canvas.getContext('2d');
	      if(/iPhone|iPad/g.test(window.navigator.userAgent) && resizeW>resizeH){
	        canvas.width = resizeH;
	        canvas.height = resizeW;
	        ctx.rotate(90 * Math.PI / 180);
	        ctx.drawImage(IMG, 0, -resizeH, resizeW, resizeH);
	      }else{
	        canvas.width = resizeW;
	        canvas.height = resizeH;
	        ctx.drawImage(IMG, 0, 0, resizeW, resizeH);
	      }
	      var base64 = canvas.toDataURL('image/jpeg', maxSize.level);
	      $("#img").attr("src",base64);
	      convertBlob(window.atob(base64.split(',')[1]), callback);
	    }
	  };
	  fileReader.readAsDataURL(file);
	}



	// base64转二进制**********************************************************************************************************
	function convertBlob(base64, callback){
	  var buffer = new ArrayBuffer(base64.length);
	  var ubuffer = new Uint8Array(buffer);
	  for (var i = 0; i < base64.length; i++) {
	    ubuffer[i] = base64.charCodeAt(i)
	  }
	  var blob;
	  try {
	    blob = new Blob([buffer], {type: 'image/jpg'});
	  } catch (e) {
	    window.BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder || window.MSBlobBuilder;
	    if(e.name === 'TypeError' && window.BlobBuilder){
	      var blobBuilder = new BlobBuilder();
	      blobBuilder.append(buffer);
	      blob = blobBuilder.getBlob('image/jpg');
	    }
	  }
	  callback(blob)
	}


	/**
	 * 获取网页地址栏url的参数
	 * @param name {string} url的key
	 * @returns {string}
	 */
	function getUrlParam(name){
	  var name = encodeURI(name);
	      arr = new RegExp("(^|&)" + name + "=([^&]*)(&|$)").exec(decodeURI(window.location.search.substr(1)));
	  if(arr){
	    return RegExp.$2;
	  }else{
	    return '';
	  }
	}

	// 时间戳处理
	function timeSplice(start,end){
		if(!start || !end){
			return;
			// throw new Error('请传递正确的时间戳');
		}
		var startArr = start.split("-"),
			endArr = end.split("-"),
			startTime = startArr[0]+"年"+startArr[1]+"月"+startArr[2],
			endTime = endArr[0]+"年"+endArr[1]+"月"+endArr[2];
		startArr = startTime.split(" ");
		startTime = startArr[0]+"日 "+startArr[1].substr(0,5);
		endArr = endTime.split(" ");
		endTime = endArr[0]+"日 "+endArr[1].substr(0,5);
		return (startTime + " ~ " + endTime);
	}

</script>
</body>
</html>