<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>报名表</title>
    <script src="js/flexible.js"></script>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-1.10.1.min.js"></script>
</head>
<body>
	<header>
		<h1 id="title"></h1>
		<!--  
		<p id="mark" class="desp"></p>
		<div class="info">
			<p id="time" class="icon time">2017年9月28-29日 8:00-17:00</p>
			<p id="address" class="icon address">香格里拉大酒店</p>
		</div>
		-->
	</header>
	<section>
		<section class="add_photo"></section>
		<section class="form">
			<form>
				<div class="left">
					<div class="preview">
						<img id="img" class="ab_center" src="" alt="">
						<span id="rephoto" class="rephoto"></span>
						
					</div>
					<span id="prompt" class="prompt t-c">请添加本人脸部照片</span>
					<input id="imageFile" class="hide" type="file" name="image" accept="image/*">
				</div>
				<div class="right">
					<div><input id="username" class="username formInput" type="text" name="username" placeholder="请输入您的姓名"><span class="icon">*</span></div>
					<div><input id="phone" class="phone formInput" type="text" name="phone" placeholder="请输入您的手机号"><span class="icon">*</span></div>
					<input id="email" class="email formInput" type="text" name="email" placeholder="请输入邮箱">
					<input id="company" class="company formInput" type="text" name="company" placeholder="请输入公司名称">
				</div>
				<button id="submit" class="submit">提 交</button>


			</form>
			<button id="submit-success" class="submit-success hide">报名成功</button>
		</section>
	</section>
	<footer>
		<p>技术支持：苏州万店掌网络科技有限公司</p>
		<p>联系方式：400-100-1392</p>
	</footer>


<!-- 遮罩和弹框 -->
	<div class="mask hide"></div>
	<div id="alert_dialog" class="ab_center dialog hide">
		<div class="top t-c alert_info"><span class="alert_icon"></span><p id="alert_dialog_info" class="alert_dialog_info">请先添加本人脸部照片</p></div>
		<hr class="ab_center">
		<button class="bottom t-c dia_botton takePhoto">确定</button>
	</div>
	<div id="info_dialog" class="ab_center dialog hide">
		<div class="top t-c alert_info"><span class="alert_icon"></span><p id="info_dialog_info" class="alert_dialog_info">请填入正确信息</p></div>
		<hr class="ab_center">
		<button class="bottom t-c dia_botton cancel">确定</button>
	</div>
	<div id="select_dialog" class="ab_center dialog hide">
		<button class="top t-c dia_botton takePhoto">拍照</button>
		<hr class="ab_center">
		<button class="bottom t-c dia_botton cancel">取消</button>
	</div>
	<div id="loading" class="loader hide">
		<ul class="loading">
	      <li></li>
	      <li></li>
	      <li></li>
	      <li></li>
	      <li></li>
	    </ul>
	    <span class="waiting">请稍后...</span>
	</div>
		<div id="successPaper" class="successPaper ab_center hide">
		<div class="gift-icon"></div>
		<div class="success-info">
			<p><strong>报名成功</strong></p>
		</div>
	</div>
<script>
    $(function(){
    	// 事件初始化
        _eventInit();
        // 页面活动信息初始化
        _amusementInfoInit();
        _showRePhoto();
    });
	var isRepeat = false;
    var disable = false;	// 阻止重复提交开关

    	// 检测输入类
    	checkInput = {
						checkName : {
							errorInfo : "",
							index : 0,
							checkFunc : function(input,callback){
								var input = checkInput._trim(input),
									empty = false;
								input = checkInput._htmlFilter(input);
								empty = checkInput._checkEmpty(input);
								if(empty){
									this.errorInfo = "请输入姓名";
									return;
								}else{
									this.errorInfo = "";
							    	callback(input);
								}
							}
						},
						checkPhone : {
							errorInfo : "",
							index : 1,
							checkFunc : function(input,callback){
								var input = checkInput._trim(input);
								input = checkInput._htmlFilter(input);
							    if(!(/^1\d{10}$/.test(input))){
							    	this.errorInfo = "请输入正确的手机号";
							    	return;
							    }else{
							    	this.errorInfo = "";
							    	callback(input);
							    }
							},
						},
						checkEmail : {
							errorInfo : "",
							index : 2,
							checkFunc : function(input,callback){
								var input = checkInput._trim(input),
									empty = true;
								input = checkInput._htmlFilter(input);
								empty = checkInput._checkEmpty(input);
								if(empty){
									this.errorInfo = "";
								}else{
									if(!(/^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/.test(input))){
										this.errorInfo = "请输入正确的邮箱";
							    		return;
									}else{
										this.errorInfo = "";
							    		callback(input);
									}
								}
							},
						},
						checkCompany : {
							errorInfo : "",
							index : 3,
							checkFunc : function(input,callback){
								var input = checkInput._trim(input),
									empty = true;
								input = checkInput._htmlFilter(input);
								callback(input);
							},
						},

						// 判空
						_checkEmpty : function(input){
							var input = checkInput._trim(input);
							if(input.length > 0) return false;
							return true;
						},
						// 去空
						_trim : function(input){
							var input = input.toString();
							if(input.trim)input = input.trim();
							input = input.replace(/\s/g,"");
							return input;
						},
						// 过滤非法字符
						_htmlFilter : function(input){
							var input = input;
							input = input.replace(/[\[\]<>\?]/g,"");
							return input;
						},
						// 判断能否提交
						_canSendOrNot : function(callback){
							for(i in this){
								if(i.toString()[0] === "_")continue;
								if(this[i].errorInfo.length > 0){
									if(callback)callback(this[i].index,this[i].errorInfo);
									return false;
								}
							}
							return true;
						}
					},
		// 检测人脸类
		checkFace = {
			sendFlag : false,
			checkFunc : function(successCallBack,failCallBack){
				var formData = new FormData();
				formData.append("file",sendFile);
                formData.append("amusementId",amusementInfo.id);
				$.ajax({
					url : "../../service/faceRecognize.action",
					type : "POST",
					contentType : false,
					processData : false,
					cache : false,
					data : formData,
					success : function(res){
						if(res.result === "ok"){
							successCallBack(res);
						}else{
                            failCallBack(res.result);
						}/*else if(res.result === "FACE_RECOGNIZE_FAILED"){
							failCallBack(res.result);
						}else if(res.result === 'ew'){

						}*/
					},
					error : function(err){
						throw new Error(err);
					}
				});
			}
		},
		sendFile = null,		// 上传的图片文件
		amusementInfo = {		// 活动信息
			id : getUrlParam("id"),
			name : getUrlParam("name"),
			// mark : getUrlParam("mark"),
			address : getUrlParam("address"),
			time : timeSplice(getUrlParam("startTime"),getUrlParam("endTime"))	
		},
		faceInfo = {			// 人脸信息
			faceToken : "",
			faceUrl : ""
		},
		userInfo = {			// 用户信息
			name : "",
			phoneNumber : "",
			mail : "",
			enterpriseName : ""
		},
		firstUpload = true;		// 第一次上传的标识


	function _amusementInfoInit(){
		for(var i in amusementInfo){
			if(!amusementInfo[i]){
				alert("请获取正确的报名链接");
				$("body").text("");
				window.close();
				return;
			}
		}
		$("#title").text(amusementInfo.name);
		// $("#mark").text(amusementInfo.mark);
		// $("#time").text(amusementInfo.time);
		// $("#address").text(amusementInfo.address);
	}


	function _eventInit(){
	    // 拍照
        $(".takePhoto").click(function(){
            $("#imageFile").click();
            hideDialog([".dialog",".mask"]);
        });

		// 取消
		$(".cancel").click(function(){
            hideDialog([".dialog",".mask"]);
		});


		// fileInput的change事件
		$("#imageFile").change(function(){
		    var self = this;
            if(this.files[0]){
            	showDialog("#loading");		// 开loading
            	$("#prompt").text("正在认证...").css("color","#b3b3b3");
            	imgResize(this.files[0],function(blob){
	            	sendFile = blob;		// 给file
	            	firstUpload = false;	// 改变flag值
	            	checkFace.checkFunc(function(res){
	            		$("#prompt").text("认证成功").css("color","#00a92e");
	            		checkFace.sendFlag = true;
	            		faceInfo.faceToken = res.data.data.faceToken;
	            		faceInfo.faceUrl = res.data.data.url;
	            		hideDialog(["#loading",".mask"]);
	            		_showRePhoto();			// 显示重新拍照icon
	            	},function(error){
                        if(error == "DUPLICATE"){
                            $("#prompt").text("您已经报过名").css("color","#d60000");
                        }else {
                            $("#prompt").text("认证失败，请重拍").css("color","#d60000");
						}

						checkFace.sendFlag = false;
						hideDialog(["#loading",".mask"]);
	            		_showRePhoto();			// 显示重新拍照icon
	            	});
	            })
            }else{
                $("#img").attr('src','');
                firstUpload = true;
                $("#rephoto").hide();
                $("#prompt").text("请添加本人脸部照片").css("color","#b3b3b3");
				hideDialog(["mask"]);
            }
		});

		// 点击提交
		$("#submit").click(function(e){
		    e.preventDefault();
		    submit(function(res){
		    	// 开启开关
				disable = true;
				if(res.result === "ok"){
					// alert("报名成功");
//					$("body").text("");
//					window.close();
                    isRepeat = true;
                    $("input").attr("disabled",true);
                    $("#submit-success").removeClass('hide');
                    $("#successPaper").removeClass('hide');
                    $(".rephoto").hide();

//                    $("#submit-success").css("background-color","#8acc47");
                    $("#submit").remove();
                    hideDialog(["#loading",".mask"]);
					return;
				}else if(res.result === "PHONE_NUMBER_ALREADY_EXIST"){
					hideDialog(["#loading"]);
					$("#info_dialog_info").text("手机号已被注册");

					// 提交按钮重置
					$("#submit").removeClass("disable");
					disable = false;

//					$(".formInput").eq(1).focus();
					showDialog("#info_dialog");
				} else{
                    hideDialog(["#loading"]);
                    showDialog("#info_dialog");
                    $("#submit").removeClass("disable");
                    disable = false;
                    $("#info_dialog_info").text("系统正忙,请稍后重试");
					return;
				}
		    });
		});

		$(".preview").click(function(e){
		    if(isRepeat) return;
//            $("#imageFile").click();
			if(firstUpload){	// 初次上传
                $("#imageFile").click();
//				showDialog("#select_dialog");
			}else{
				return;
			}
		});

		$("#rephoto").click(function(e){
            if(isRepeat) return;
            $("#imageFile").click();
//			showDialog("#select_dialog");
		});
	}


	// 显示重新拍照icon的开关
	function _showRePhoto(){
		if(firstUpload){
			$("#rephoto").hide();
		}else{
			$("#rephoto").show();
		}
	}



	// 提交
	function submit(successCallBack){
		if(disable)return;	// 阻止重复提交
		var flag,
			formData;
		// 人脸检测****************************************************
		if(!$("#imageFile")[0].files[0]){
			changeDialogInfo("请先添加本人脸部照片");
			showDialog("#alert_dialog");
			return;
		}
		if(!checkFace.sendFlag || !faceInfo.faceToken || !faceInfo.faceUrl){
			changeDialogInfo("请重新拍摄一张图片");
			showDialog("#alert_dialog");
			return;
		}

		// 数据检测*******************************************************
		flag = checkData();
		if(!flag){	// 检测不通过情况
			checkInput._canSendOrNot(function(index,errorInfo){
				$("#info_dialog_info").text(errorInfo);
//				$(".formInput").eq(0).focus();
				showDialog("#info_dialog");
			});
			return;
		}

		// 提交按钮置灰
		$("#submit").addClass("disable");

		// 开遮罩层
		showDialog("#loading");

		// 注册***********************************************************
		formData = fillFormData();
		$.ajax({
			url : "../../service/registerAmusementUser.action",
			type : "POST",
			contentType : false,
			processData : false,
			cache : false,
			data : formData,
			success : function(res){
				successCallBack(res);
			},
			error : function(err){
				throw new Error(err);
				// 开启开关
				disable = true;
			}
		});
	}

	// 填充数据
	function fillFormData(){
		var formData = new FormData(),
			amusementUserJson = JSON.stringify({
				faceToken : faceInfo.faceToken,
				faceUrl : faceInfo.faceUrl,
				amusementId : amusementInfo.id,
				name : userInfo.name,
				phoneNumber : userInfo.phoneNumber,
				mail : userInfo.mail,
				enterpriseName : userInfo.enterpriseName
			});
		formData.append("amusementUserJson",amusementUserJson);
		// formData.append("file",sendFile);
		return formData;
	}

	// 检测输入
	function checkData(){
		var username       = $("#username").val(),
			phoneNumber    = $("#phone").val(),
			mail           = $("#email").val(),
			enterpriseName = $("#company").val();
		checkInput.checkName.checkFunc(username,function(input){
			userInfo.name = input;
		});
		checkInput.checkPhone.checkFunc(phoneNumber,function(input){
			userInfo.phoneNumber = input;
		});
		checkInput.checkEmail.checkFunc(mail,function(input){
			userInfo.mail = input;
		});
		checkInput.checkCompany.checkFunc(enterpriseName,function(input){
			userInfo.enterpriseName = input;
		});
		
		return checkInput._canSendOrNot();
	}


	// 改变弹出框提示语
	function changeDialogInfo(info){
		$("#alert_dialog_info").text(info);
	}


    /**
	 * 隐藏弹框
     * @param arr {array} 选择符数组
     */
	function hideDialog(arr){
		var target = arr.join(",");
		$(target).animate({
			opacity : 0
		},100,function(){
			$(target).hide();
		});
	}

	// 显示弹框
	function showDialog(dialogName){
		var target = dialogName + ",.mask";
		$(target).show().css({
			opacity : 0
		}).animate({
			opacity : 1
		},100);
	}



	// 图片压缩**************************************************************************************************************
	function imgResize(file, callback){
	  var fileReader = new FileReader();
	  fileReader.onload = function(){
	    var IMG = new Image();
	    IMG.src = this.result;
	    IMG.onload = function(){
	      var w = this.naturalWidth, h = this.naturalHeight, resizeW = 0, resizeH = 0;
	      // maxSize 是压缩的设置，设置图片的最大宽度和最大高度，等比缩放，level是报错的质量，数值越小质量越低
	      var maxSize = {
	        width: 500,
	        height: 500,
	        level: 0.6
	      };
	      if(w > maxSize.width || h > maxSize.height){
	        var multiple = Math.max(w / maxSize.width, h / maxSize.height);
	        resizeW = w / multiple;
	        resizeH = h / multiple;
	      } else {
	        // 如果图片尺寸小于最大限制，则不压缩直接上传
	        $("#img").attr("src",IMG.src);
	        return callback(file)
	      }
	      var canvas = document.createElement('canvas'),
	      ctx = canvas.getContext('2d');
	      if(/MI 6/g.test(window.navigator.userAgent)){
	      	canvas.width = resizeH;
	        canvas.height = resizeW;
	        ctx.rotate(-90 * Math.PI / 180);
	        ctx.drawImage(IMG, -resizeW, 0, resizeW, resizeH);
	      }else if(resizeW>resizeH){// /iPhone|iPad/g.test(window.navigator.userAgent) && 
	        canvas.width = resizeH;
	        canvas.height = resizeW;
	        ctx.rotate(90 * Math.PI / 180);
	        ctx.drawImage(IMG, 0, -resizeH, resizeW, resizeH);
	      }else{
	        canvas.width = resizeW;
	        canvas.height = resizeH;
	        ctx.drawImage(IMG, 0, 0, resizeW, resizeH);
	      }
	      var base64 = canvas.toDataURL('image/jpeg', maxSize.level);
	      $("#img").attr("src",base64);
	      convertBlob(window.atob(base64.split(',')[1]), callback);
	    }
	  };
	  fileReader.readAsDataURL(file);
	}



	// base64转二进制**********************************************************************************************************
	function convertBlob(base64, callback){
	  var buffer = new ArrayBuffer(base64.length);
	  var ubuffer = new Uint8Array(buffer);
	  for (var i = 0; i < base64.length; i++) {
	    ubuffer[i] = base64.charCodeAt(i)
	  }
	  var blob;
	  try {
	    blob = new Blob([buffer], {type: 'image/jpg'});
	  } catch (e) {
	    window.BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder || window.MSBlobBuilder;
	    if(e.name === 'TypeError' && window.BlobBuilder){
	      var blobBuilder = new BlobBuilder();
	      blobBuilder.append(buffer);
	      blob = blobBuilder.getBlob('image/jpg');
	    }
	  }
	  callback(blob)
	}


	/**
	 * 获取网页地址栏url的参数
	 * @param name {string} url的key
	 * @returns {string}
	 */
	function getUrlParam(name){
	  var name = encodeURI(name);
	      arr = new RegExp("(^|&)" + name + "=([^&]*)(&|$)").exec(decodeURI(window.location.search.substr(1)));
	  if(arr){
	    return RegExp.$2;
	  }else{
	    return '';
	  }
	}

	// 时间戳处理
	function timeSplice(start,end){
		if(!start || !end){
			return;
			// throw new Error('请传递正确的时间戳');
		}
		var startArr = start.split("-"),
			endArr = end.split("-"),
			startTime = startArr[0]+"年"+startArr[1]+"月"+startArr[2],
			endTime = endArr[0]+"年"+endArr[1]+"月"+endArr[2];
		startArr = startTime.split(" ");
		startTime = startArr[0]+"日 "+startArr[1].substr(0,5);
		endArr = endTime.split(" ");
		endTime = endArr[0]+"日 "+endArr[1].substr(0,5);
		return (startTime + " ~ " + endTime);
	}

</script>
</body>
</html>